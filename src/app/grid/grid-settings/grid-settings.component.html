<div
    style="
        display: grid;
        grid-template-rows: minmax(0, 1fr) max-content;
        height: 100%;
    "
>
    <div style="min-height: 0; overflow: auto; padding: 20px 20px">
        <form
            *ngIf="loaded"
            [formGroup]="gridForm"
            style="display: flex; flex-flow: column"
            (keydown.control.enter)="save()"
        >
            <ng-container formGroupName="baseParams">
                <mat-form-field appearance="outline" [class.diff]="showDiffs">
                    <mat-label>Prompt</mat-label>
                    <textarea
                        matInput
                        cdkTextareaAutosize
                        formControlName="prompt"
                    ></textarea>
                    <mat-hint *ngIf="showDiffs">
                        <ng-container
                            *ngTemplateOutlet="
                                hintTemplate;
                                context: { diff: formDiff.baseParams.prompt }
                            "
                        >
                        </ng-container>
                    </mat-hint>
                </mat-form-field>
                <mat-form-field appearance="outline" [class.diff]="showDiffs">
                    <mat-label for="prompt_negative">Negative Prompt</mat-label>
                    <textarea
                        matInput
                        cdkTextareaAutosize
                        formControlName="prompt_negative"
                    ></textarea>
                    <mat-hint *ngIf="showDiffs">
                        <ng-container
                            *ngTemplateOutlet="
                                hintTemplate;
                                context: {
                                    diff: formDiff.baseParams.prompt_negative
                                }
                            "
                        >
                        </ng-container>
                    </mat-hint>
                </mat-form-field>
                <div>
                    <mat-form-field
                        appearance="outline"
                        [class.diff]="showDiffs"
                    >
                        <mat-label>Sampler</mat-label>
                        <mat-select formControlName="sampler">
                            <mat-option
                                *ngFor="let smplr of ['Euler', 'Euler a']"
                                [value]="smplr"
                            >
                                {{ smplr }}
                            </mat-option>
                        </mat-select>
                        <mat-hint *ngIf="showDiffs">
                            <ng-container
                                *ngTemplateOutlet="
                                    hintTemplate;
                                    context: {
                                        diff: formDiff.baseParams.sampler
                                    }
                                "
                            >
                            </ng-container>
                        </mat-hint>
                    </mat-form-field>
                    <mat-form-field
                        appearance="outline"
                        [class.diff]="showDiffs"
                    >
                        <mat-label>Steps</mat-label>
                        <input formControlName="steps" matInput type="number" />
                        <mat-hint *ngIf="showDiffs">
                            <ng-container
                                *ngTemplateOutlet="
                                    hintTemplate;
                                    context: {
                                        diff: formDiff.baseParams.steps
                                    }
                                "
                            >
                            </ng-container>
                        </mat-hint>
                    </mat-form-field>
                </div>
                <div>
                    <mat-form-field
                        appearance="outline"
                        [class.diff]="showDiffs"
                    >
                        <mat-label>Height</mat-label>
                        <input
                            formControlName="height"
                            matInput
                            type="number"
                        />
                        <mat-hint *ngIf="showDiffs">
                            <ng-container
                                *ngTemplateOutlet="
                                    hintTemplate;
                                    context: {
                                        diff: formDiff.baseParams.height
                                    }
                                "
                            >
                            </ng-container>
                        </mat-hint>
                    </mat-form-field>
                    <mat-form-field
                        appearance="outline"
                        [class.diff]="showDiffs"
                    >
                        <mat-label>Width</mat-label>
                        <input formControlName="width" matInput type="number" />
                        <mat-hint *ngIf="showDiffs">
                            <ng-container
                                *ngTemplateOutlet="
                                    hintTemplate;
                                    context: {
                                        diff: formDiff.baseParams.width
                                    }
                                "
                            >
                            </ng-container>
                        </mat-hint>
                    </mat-form-field>
                </div>
                <div>
                    <mat-form-field
                        appearance="outline"
                        [class.diff]="showDiffs"
                    >
                        <mat-label>CFG Scale</mat-label>
                        <input
                            formControlName="cfg_scale"
                            matInput
                            type="number"
                        />
                        <mat-hint *ngIf="showDiffs">
                            <ng-container
                                *ngTemplateOutlet="
                                    hintTemplate;
                                    context: {
                                        diff: formDiff.baseParams.cfg_scale
                                    }
                                "
                            >
                            </ng-container>
                        </mat-hint>
                    </mat-form-field>
                    <mat-form-field
                        appearance="outline"
                        [class.diff]="showDiffs"
                    >
                        <mat-label>Seed</mat-label>
                        <input formControlName="seed" matInput type="number" />
                        <mat-hint *ngIf="showDiffs">
                            <ng-container
                                *ngTemplateOutlet="
                                    hintTemplate;
                                    context: {
                                        diff: formDiff.baseParams.seed
                                    }
                                "
                            >
                            </ng-container>
                        </mat-hint>
                    </mat-form-field>
                </div>
            </ng-container>

            <mat-divider></mat-divider>

            <!-- x-axis -->
            <ng-container
                *ngTemplateOutlet="
                    axisTemplate;
                    context: {
                        controlId: 'xAxis',
                        title: 'X-Axis',
                        formGroup: gridForm
                    }
                "
            ></ng-container>

            <mat-divider></mat-divider>

            <!-- y axis -->
            <ng-container
                *ngTemplateOutlet="
                    axisTemplate;
                    context: {
                        controlId: 'yAxis',
                        title: 'Y-Axis',
                        formGroup: gridForm
                    }
                "
            ></ng-container>
        </form>
    </div>

    <mat-toolbar class="flex-row" style="justify-content: space-between">
        <div class="flex-row">
            <mat-checkbox [(ngModel)]="showDiffs">Show changes</mat-checkbox>
        </div>
        <div class="flex-row">
            <button [disabled]="!hasChanges" (click)="reset()" mat-button>
                Reset
            </button>
            <button (click)="save()" mat-button>Save</button>
        </div>
    </mat-toolbar>
</div>

<style>
    form > div {
        display: flex;
        justify-content: space-between;
    }

    .las {
        font-size: 1.7em;
        height: 30px;
        width: 30px;
        margin-top: 4px;
    }

    .mt-17 {
        margin-top: 10px;
    }

    .mat-divider {
        margin: 5px 0px 25px 0px;
    }

    .diff {
        margin-bottom: 15px;
    }

    ::ng-deep .diff .mat-form-field-subscript-wrapper {
        top: calc(100% - 1.83em);
    }

    ::ng-deep .mat-checkbox {
        font-size: 14px;
    }
    ::ng-deep .mat-checkbox-frame,
    ::ng-deep .mat-checkbox-background {
        transform: scale(0.8);
    }
</style>

<ng-template
    #axisTemplate
    let-controlId="controlId"
    let-title="title"
    let-formGroup="formGroup"
>
    <div [formGroup]="formGroup" class="flex-row">
        <div
            *ngLet="$any(gridForm.controls)[controlId].value as axisId"
            class="flex-col"
            style="width: 100%"
        >
            <!-- axis type -->
            <mat-form-field appearance="outline" [class.diff]="showDiffs">
                <mat-label>{{ title }}</mat-label>
                <mat-select [formControlName]="controlId">
                    <mat-option
                        *ngFor="
                            let opt of gridForm.controls['axisOptions'].controls
                                | keyvalue
                        "
                        [value]="$any(AXES)[opt.key].id"
                    >
                        {{ $any(AXES)[opt.key].name }}
                    </mat-option>
                </mat-select>
                <mat-hint *ngIf="showDiffs">
                    <ng-container *ngIf="formDiff[controlId].name as diff">
                        <span *ngIf="diff.added" style="color: green">
                            + {{ diff.added | json }}
                        </span>
                        <br />
                        <span *ngIf="diff.removed" style="color: red">
                            - {{ diff.removed | json }}
                        </span>
                    </ng-container>
                </mat-hint>
            </mat-form-field>

            <!-- axis values -->
            <ng-container formGroupName="axisOptions">
                <ng-container
                    *ngLet="
                        $any(
                            $any(gridForm.controls.axisOptions).controls[axisId]
                        ) as controlArray
                    "
                    [formArrayName]="axisId"
                >
                    <div
                        *ngFor="
                            let x of controlArray.controls;
                            let i = index;
                            trackBy: trackByAxis
                        "
                        style="
                            display: grid;
                            grid-template-columns: 1fr repeat(4, max-content);
                        "
                    >
                        <mat-form-field appearance="outline">
                            <mat-label>{{ $any(AXES)[axisId].name }}</mat-label>
                            <input
                                #input
                                matInput
                                type="number"
                                [formControlName]="i"
                            />
                        </mat-form-field>
                        <button
                            #down
                            (click)="onAxisReorder(controlArray, i, i + 1)"
                            mat-icon-button
                            class="mt-17"
                            (keydown.ArrowLeft)="
                                onAxisButtonCycle($any(down), -1)
                            "
                            (keydown.ArrowRight)="
                                onAxisButtonCycle($any(down), 1)
                            "
                            (keydown.shift.tab)="
                                $event.preventDefault(); input.focus()
                            "
                        >
                            <i class="las la-arrow-down"></i>
                        </button>
                        <button
                            #up
                            (click)="onAxisReorder(controlArray, i, i - 1)"
                            mat-icon-button
                            class="mt-17"
                            (keydown.ArrowLeft)="
                                onAxisButtonCycle($any(up), -1)
                            "
                            (keydown.ArrowRight)="
                                onAxisButtonCycle($any(up), 1)
                            "
                            (keydown.shift.tab)="
                                $event.preventDefault(); input.focus()
                            "
                            tabindex="-1"
                        >
                            <i class="las la-arrow-up"></i>
                        </button>
                        <button
                            #add
                            mat-icon-button
                            class="mt-17"
                            (keydown.ArrowLeft)="
                                onAxisButtonCycle($any(add), -1)
                            "
                            (keydown.ArrowRight)="
                                onAxisButtonCycle($any(add), 1)
                            "
                            (keydown.shift.tab)="
                                $event.preventDefault(); input.focus()
                            "
                            tabindex="-1"
                        >
                            <i class="las la-plus"></i>
                        </button>
                        <button
                            #remove
                            mat-icon-button
                            class="mt-17"
                            (keydown.ArrowLeft)="
                                onAxisButtonCycle($any(remove), -1)
                            "
                            (keydown.ArrowRight)="
                                onAxisButtonCycle($any(remove), 1)
                            "
                            tabindex="-1"
                            (keydown.shift.tab)="
                                $event.preventDefault(); input.focus()
                            "
                            [disabled]="i === 0"
                        >
                            <i class="las la-times"></i>
                        </button>
                    </div>
                </ng-container>
            </ng-container>
        </div>
    </div>
</ng-template>

<ng-template #hintTemplate let-diff="diff">
    <ng-container *ngIf="diff">
        <span *ngIf="diff.added" style="color: green">
            + {{ diff.added | json }}
        </span>
        <br />
        <span *ngIf="diff.removed" style="color: red">
            - {{ diff.removed | json }}
        </span>
    </ng-container>
</ng-template>
